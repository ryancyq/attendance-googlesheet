<script>
  $(function() {
    $('#sidebar-fillup-frequency').change(onFrequencyChanged);
    $('#sidebar-create-button').click(onCreateClick);

    utils.disableButtons();

    clearOptions();
    onFrequencyChanged();

    utils.enableButtons();
  });

  /**
   * Show the start date if frequency is Daily/Weekly
   */
  function updateFrequencyDaily() {
    var freq = $('#sidebar-fillup-frequency').find(":selected").val();
    var $startDate = $('#sidebar-fillup-start-date-panel');

    if (freq === 'd' || freq === 'w') {
      // daily or weekly
      $startDate.removeClass('hidden');
    } else {
      // others
      $startDate.addClass('hidden');
    }
  }

  /**
   * Show the end date & selection of days in/per week if frequency is Weekly
   */
  function updateFrequencyWeekly() {
    var freq = $('#sidebar-fillup-frequency').find(":selected").val();
    var $endDate = $('#sidebar-fillup-end-date-panel');
    var $daysInWeek = $('#sidebar-fillup-days-in-week-panel');

    if (freq === 'w') {
      // weekly
      $endDate.removeClass('hidden');
      $daysInWeek.removeClass('hidden');
    } else {
      // others
      $endDate.addClass('hidden');
      $daysInWeek.addClass('hidden');
    }
  }

  /**
   * Show the sheet name and range for custom dates if frequency is Custom Dates
   */
  function updateFrequencyCustomDates() {
    var freq = $('#sidebar-fillup-frequency').find(":selected").val();
    var $customDates = $('#sidebar-fillup-custom-dates-panel');

    if (freq === 'c') {
      // custom dates
      $customDates.removeClass('hidden');
    } else {
      // others
      $customDates.addClass('hidden');
    }
  }

  function onFrequencyChanged() {
    updateFrequencyDaily();
    updateFrequencyWeekly();
    updateFrequencyCustomDates();
  }

  function onCreateClick() {
    utils.disableButtons();
    utils.enableLoader();

    var createOptions = getOptions();

    google.script.run
      .withSuccessHandler(
        function(msg) {
          utils.success('Success! The roster timetable has been created');
        })
      .withFailureHandler(
        function(msg) {
          utils.failure(msg);
        })
      .createNew(createOptions.sheetname, createOptions.frequency, createOptions.daysDisplay, createOptions.showNext, createOptions.daysInWeek, createOptions.customSheetname, createOptions.customRange);
  }

  function getOptions() {
    return {
      sheetname: $('#sidebar-fillup-sheetname').val().trim(),
      frequency: $('#sidebar-fillup-frequency').val(),
      customSheetname: $('#sidebar-fillup-frequency-custom-sheetname').val(),
      customRange: $('#sidebar-fillup-frequency-custom-range').val(),
      daysInWeek: $.map($('#sidebar-fillup-days-in-week input:checked'), function(e) {
        return $(e).val();
      }),
      daysDisplay: $('#sidebar-fillup-days-display').val().trim(),
      showNext: $('#sidebar-fillup-show-next input:checkbox').is(':checked')
    };
  }

  function clearOptions() {
    $('#sidebar-fillup-sheetname').val($('#sidebar-fillup-sheetname-default').val());
    $('#sidebar-fillup-frequency').val('d');
    $('#sidebar-fillup-frequency-custom-sheetname').val('');
    $('#sidebar-fillup-frequency-custom-range').val('');
    $('#sidebar-fillup-days-in-week input:checkbox').removeAttr('checked');
    $('#sidebar-fillup-days-display').val('3');
    $('#sidebar-fillup-show-next input:checkbox').removeAttr('checked');
  }
</script>
