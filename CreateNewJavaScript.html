<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
  $(function() {
    $('#sidebar-fillup-frequency').change(onFrequencyChanged);
    $('#sidebar-create-button').click(onCreateClick);

    utils.disableButtons();

    clearOptions();
    updateFrequencyCustom();
    updateDaysInWeek();

    utils.enableButtons();
  });

  /**
   * Show/hide the selection of days in week
   * if frequency not Weekly or Monthly
   */
  function updateDaysInWeek() {
    var freq = $('#sidebar-fillup-frequency').find(":selected").val();
    var $daysInWeek = $('#sidebar-fillup-days-in-week');

    if (freq === 'w' || freq === 'm') {
      // weekly or monthly
      $daysInWeek.removeClass('hidden');
    } else {
      // others
      $daysInWeek.addClass('hidden');
    }
  }

  /**
   * Show/hide the sheet name and range for custom frequency
   * if frequency not Weekly or Monthly
   */
  function updateFrequencyCustom() {
    var freq = $('#sidebar-fillup-frequency').find(":selected").val();
    var $customFreq = $('#sidebar-fillup-frequency-custom');

    if (freq === 'c') {
      // custom frequency
      $customFreq.removeClass('hidden');
    } else {
      // others
      $customFreq.addClass('hidden');
    }
  }

  function onFrequencyChanged() {
    updateFrequencyCustom();
    updateDaysInWeek();
  }

  function onCreateClick() {
    utils.disableButtons();
    utils.enableLoader();

    var createOptions = getOptions();

    google.script.run
      .withSuccessHandler(
        function(msg) {
          utils.success('Success! The roster timetable has been created');
        })
      .withFailureHandler(
        function(msg) {
          util.failure(msg);
        })
      .createNew(createOptions.sheetname, createOptions.frequency, createOptions.daysDisplay, createOptions.showNext, createOptions.daysInWeek, createOptions.customSheetname, createOptions.customRange);
  }

  function getOptions() {
    return {
      sheetname: $('#sidebar-fillup-sheetname').val().trim(),
      frequency: $('#sidebar-fillup-frequency').val(),
      customSheetname: $('#sidebar-fillup-frequency-custom-sheetname').val(),
      customRange: $('#sidebar-fillup-frequency-custom-range').val(),
      daysInWeek: $.map($('#sidebar-fillup-days-in-week input:checked'), function(e) {
        return $(e).val();
      }),
      daysDisplay: $('#sidebar-fillup-days-display').val().trim(),
      showNext: $('#sidebar-fillup-show-next input:checkbox').is(':checked')
    };
  }

  function clearOptions() {
    $('#sidebar-fillup-sheetname').val($('#sidebar-fillup-sheetname-default').val());
    $('#sidebar-fillup-frequency').val('d');
    $('#sidebar-fillup-frequency-custom-sheetname').val('');
    $('#sidebar-fillup-frequency-custom-range').val('');
    $('#sidebar-fillup-days-in-week input:checkbox').removeAttr('checked');
    $('#sidebar-fillup-days-display').val('3');
    $('#sidebar-fillup-show-next input:checkbox').removeAttr('checked');
  }
</script>
